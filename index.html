<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="manifest" href="manifest.json" />
  <title>Pengingat Waktu Sholat</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      background: #f2f2f2;
      color: #333;
    }
    h1 {
      text-align: center;
    }
    .countdown {
      font-size: 1.2em;
      margin-top: 10px;
    }
    .sholat {
      margin: 10px 0;
    }
  </style>
</head>
<body>
  <h1>Pengingat Waktu Sholat</h1>
  <div id="jadwal"></div>
  <div class="countdown" id="countdown">Menghitung waktu sholat...</div>
  <label>
    Notifikasi sebelum adzan (menit):
    <input type="number" id="offset" value="5" min="0" style="width:60px"/>
  </label>

  <audio id="adzanBiasa" src="adzan_biasa.mp3"></audio>
  <audio id="adzanSubuh" src="adzan_subuh.mp3"></audio>

  <script>
    const jadwalContainer = document.getElementById("jadwal");
    const countdown = document.getElementById("countdown");
    const offsetInput = document.getElementById("offset");

    let jadwalSholat = {};
    let waktuBerikutnya = null;
    let namaSholat = "";

    function formatJam(date) {
      return date.toTimeString().slice(0, 5);
    }

    function tampilkanJadwal(data) {
      jadwalContainer.innerHTML = "";
      const waktu = data.data.timings;
      const mapping = {
        Fajr: "Shubuh",
        Dhuhr: "Dhuhur",
        Asr: "Ashar",
        Maghrib: "Maghrib",
        Isha: "Isya"
      };

      jadwalSholat = {};
      for (let key in mapping) {
        const waktuFix = waktu[key].split(" ")[0];
        jadwalSholat[mapping[key]] = waktuFix;
        const el = document.createElement("div");
        el.className = "sholat";
        el.textContent = `${mapping[key]}: ${waktuFix}`;
        jadwalContainer.appendChild(el);
      }
    }

    function updateCountdown() {
      const now = new Date();
      const offset = parseInt(offsetInput.value) || 0;
      for (let [nama, jam] of Object.entries(jadwalSholat)) {
        const [h, m] = jam.split(":");
        const waktu = new Date(now);
        waktu.setHours(parseInt(h), parseInt(m), 0, 0);
        const waktuNotifikasi = new Date(waktu - offset * 60000);

        if (waktuNotifikasi > now) {
          waktuBerikutnya = waktu;
          namaSholat = nama;
          const selisih = waktuNotifikasi - now;
          const menit = Math.floor(selisih / 60000);
          const detik = Math.floor((selisih % 60000) / 1000);
          countdown.textContent = `Menuju ${nama} (notifikasi ${offset} menit sebelumnya): ${menit}m ${detik}s`;
          break;
        }
      }
    }

    function cekNotifikasi() {
      const now = new Date();
      if (waktuBerikutnya && Math.abs(waktuBerikutnya - now) < 1000) {
        notifikasiAdzan(namaSholat);
        waktuBerikutnya = null;
      }
    }

    function notifikasiAdzan(nama) {
      const audio = nama === "Shubuh" ? document.getElementById("adzanSubuh") : document.getElementById("adzanBiasa");
      audio.play();
      if (Notification.permission === "granted") {
        new Notification("Waktu Sholat " + nama, {
          body: "Saatnya melaksanakan sholat " + nama,
        });
      }
    }

    function mintaIzinNotif() {
      if ("Notification" in window && Notification.permission !== "granted") {
        Notification.requestPermission();
      }
    }

    function ambilJadwal(lat, lon) {
      fetch(`https://api.aladhan.com/v1/timings?latitude=${lat}&longitude=${lon}&method=2`)
        .then(res => res.json())
        .then(data => tampilkanJadwal(data));
    }

    if ("geolocation" in navigator) {
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const { latitude, longitude } = pos.coords;
          ambilJadwal(latitude, longitude);
        },
        (err) => alert("Gagal mengambil lokasi: " + err.message)
      );
    } else {
      alert("Geolocation tidak didukung di perangkat ini.");
    }

    setInterval(updateCountdown, 1000);
    setInterval(cekNotifikasi, 1000);
    mintaIzinNotif();

    // PWA setup
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("service-worker.js").then(() => {
        console.log("Service Worker terdaftar!");
      });
    }
  </script>
</body>
</html>
